<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Conecta Idoso - Perfil</title>
  <link rel="stylesheet" href="css/estilo.css">
</head>
<body class="pagina-perfil">
  <div class="caixa">
    <!-- Cabe√ßalho -->
    <div class="cabecalho">
      <button class="btn-voltar" onclick="window.location.href='painel-adm.html'">Voltar</button>
  <img src="/images/logo-pequena.jpeg" alt="Conecta Idoso" class="logo">
      <button class="btn-sair" onclick="sair()">Sair</button>
    </div>

    <h2>Perfil Cadastrado</h2>
    
    <!-- Conte√∫do -->
    <div class="conteudo-perfil">
      <!-- debug removido -->
      <!-- Bloco Idoso -->
      <div class="bloco-perfil bloco-idoso">
        <h3>üë¥ Informa√ß√µes do Idoso</h3>
        <label>Nome:</label>
        <input type="text" id="nomeIdosoPerfil" disabled>

        <label>Telefone:</label>
        <input type="text" id="telefoneIdosoPerfil" disabled>

        <label>Endere√ßo:</label>
        <input type="text" id="enderecoIdosoPerfil" disabled>
      </div>

      <!-- Bloco Administrador -->
      <div class="bloco-perfil bloco-admin">
        <h3>üë§ Informa√ß√µes do Administrador</h3>
        <label>Nome:</label>
        <input type="text" id="nomeAdmPerfil" disabled>

        <label>Telefone:</label>
        <input type="text" id="telefoneAdmPerfil" disabled>

        <label>Endere√ßo:</label>
        <input type="text" id="enderecoAdmPerfil" disabled>
      </div>
      
      <!-- Bot√µes -->
      <div class="acoes-perfil">
        <button class="btn-editar" id="btnEditar" onclick="editarInformacoes()">Editar Informa√ß√µes</button>
        <button class="btn-salvar" id="btnSalvar" style="display:none;" onclick="salvarInformacoes()">Salvar Altera√ß√µes</button>
      </div>
    </div>
    </div>

    <script src="/js/app.js"></script>

    <script>
    // REMOVIDA A FUN√á√ÉO voltarPainel() DAQUI (agora est√° no app.js)

    // Carrega dados salvos (agora usando usuarioLogado quando dispon√≠vel)
    window.onload = async () => {
      // tenta garantir que temos o usuarioLogado atualizado (via backend) antes de preencher o DOM
      await window.buscarEAtualizarUsuarioLogado();

      const usuarioRaw = localStorage.getItem('usuarioLogado');
      let usuario = null;
      try {
        usuario = usuarioRaw ? JSON.parse(usuarioRaw) : null;
      } catch (e) {
        usuario = null;
      }

      // debug vis√≠vel removido; mantemos logs no console
      console.log('perfil - usuarioLogado raw:', usuarioRaw);
      console.log('perfil - usuario parsed:', usuario);

      if (usuario) {
        const isAdmin = usuario.isAdmin === true || usuario.isAdmin === 'true' || usuario.isAdmin === 1;

        if (isAdmin) {
          // preencher bloco admin com dados do usu√°rio logado
          document.getElementById('nomeAdmPerfil').value = usuario.nome || '';
          document.getElementById('telefoneAdmPerfil').value = usuario.telefone || '';
          document.getElementById('enderecoAdmPerfil').value = usuario.endereco || localStorage.getItem('enderecoAdm') || '';

          // idoso associado: podemos preencher telefone com usuario.contato (telefone do idoso)
          const telefoneIdoso = usuario.contato || localStorage.getItem('telefoneIdoso') || '';
          document.getElementById('telefoneIdosoPerfil').value = telefoneIdoso;

          // tentar buscar dados do idoso pelo telefone (se dispon√≠vel) e preencher nome/endereco
          if (telefoneIdoso) {
            try {
              const idoso = await window.fetchUsuarioPorTelefone(telefoneIdoso);
              if (idoso) {
                document.getElementById('nomeIdosoPerfil').value = idoso.nome || '';
                document.getElementById('enderecoIdosoPerfil').value = idoso.endereco || '';
                // tamb√©m salvar para compatibilidade futura
                localStorage.setItem('nomeIdoso', idoso.nome || '');
                localStorage.setItem('enderecoIdoso', idoso.endereco || '');
              }
            } catch(e) {
              console.debug('N√£o foi poss√≠vel buscar idoso por telefone:', telefoneIdoso, e.message || e);
            }
          }
        } else {
          // usu√°rio comum -> preencher bloco idoso com dados do usuario
          document.getElementById('nomeIdosoPerfil').value = usuario.nome || '';
          document.getElementById('telefoneIdosoPerfil').value = usuario.telefone || '';
          document.getElementById('enderecoIdosoPerfil').value = usuario.endereco || localStorage.getItem('enderecoIdoso') || '';

          // preencher bloco admin com contato de emerg√™ncia (se existir)
          const telefoneAdm = usuario.contato || localStorage.getItem('telefoneAdm') || '';
          document.getElementById('telefoneAdmPerfil').value = telefoneAdm;
          // se tiver telefone do admin, tentar buscar os dados do admin
          if (telefoneAdm) {
            try {
              const adm = await window.fetchUsuarioPorTelefone(telefoneAdm);
              if (adm) {
                document.getElementById('nomeAdmPerfil').value = adm.nome || '';
                document.getElementById('enderecoAdmPerfil').value = adm.endereco || '';
                localStorage.setItem('nomeAdm', adm.nome || '');
                localStorage.setItem('enderecoAdm', adm.endereco || '');
              }
            } catch(e) {
              console.debug('N√£o foi poss√≠vel buscar admin por telefone:', telefoneAdm, e.message || e);
            }
          } else {
            document.getElementById('nomeAdmPerfil').value = localStorage.getItem('nomeAdm') || '';
            document.getElementById('enderecoAdmPerfil').value = localStorage.getItem('enderecoAdm') || '';
          }
        }
      } else {
        // fallback para compatibilidade anterior (usando chaves individuais no localStorage)
        document.getElementById('nomeIdosoPerfil').value = localStorage.getItem('nomeIdoso') || '';
        document.getElementById('telefoneIdosoPerfil').value = localStorage.getItem('telefoneIdoso') || '';
        document.getElementById('enderecoIdosoPerfil').value = localStorage.getItem('enderecoIdoso') || '';

        document.getElementById('nomeAdmPerfil').value = localStorage.getItem('nomeAdm') || '';
        document.getElementById('telefoneAdmPerfil').value = localStorage.getItem('telefoneAdm') || '';
        document.getElementById('enderecoAdmPerfil').value = localStorage.getItem('enderecoAdm') || '';
      }
    };

  </script>
  
  <script src="/js/app.js"></script>
</body>
</html>