<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Conecta Idoso - Áudios</title>
  <link rel="stylesheet" href="/css/main.css">
</head>
<body class="pagina-conteudo">
  <div class="caixa">
    <div class="cabecalho">
      <button class="btn-voltar" onclick="window.location.href='biblioteca.html'">Voltar</button>
      <img src="/images/logo-pequena.jpeg" alt="Conecta Idoso" class="logo">
      <button class="btn-sair" onclick="sair()">Sair</button>
    </div>

    <div class="cabecalho-pagina">
      <h1 class="titulo-principal">Áudios</h1>
      <p class="subtitulo">Escolha um áudio para ouvir:</p>
    </div>

    <main class="lista-conteudo" id="lista-de-audios"></main>

    <div class="area-botao-adicionar">
      <button class="btn-adicionar" id="btn-abrir-modal">+ Adicionar Áudio</button>
    </div>
  </div>

  <div id="player-youtube-escondido"></div>

  <div class="modal-overlay" id="modal-adicionar-audio">
    <div class="modal-caixa-grande">
      <form id="form-audio" class="form-duas-colunas">
        <div class="modal-coluna">
          <h3 class="modal-titulo">Adicionar Novo Áudio</h3>
          <div class="form-grupo">
            <label for="audio-titulo">Título do Áudio</label>
            <input type="text" id="audio-titulo" required>
          </div>
          <div class="form-grupo">
            <label for="audio-desc">Descrição</label>
            <input type="text" id="audio-desc" required>
          </div>
          <div class="form-grupo">
            <label for="audio-link">Link do Vídeo/Áudio do YouTube</label>
            <input type="url" id="audio-link" placeholder="Cole o link do YouTube aqui..." required>
          </div>
          <div class="form-grupo">
            <label for="audio-tag">Categoria</label>
            <select id="audio-tag">
              <option value="Segurança">Segurança</option>
              <option value="Privacidade">Privacidade</option>
              <option value="Tecnologia">Tecnologia</option>
              <option value="Geral">Geral</option>
            </select>
          </div>
        </div>

        <div class="modal-coluna">
          <div class="form-grupo form-grupo-editor">
            <label>Pré-visualização</label>
            <div class="preview-container" id="audio-preview-container">
              <p class="preview-placeholder">A pré-visualização do vídeo/áudio aparecerá aqui.</p>
            </div>
          </div>
        </div>
        
        <div class="modal-acoes-rodape">
          <button type="button" class="btn-cancelar" id="btn-fechar-modal">Cancelar</button>
          <button type="submit" class="btn-salvar">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    let player;
    let itemTocandoAtualmente = null;
    let progressInterval;

    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player-youtube-escondido', { height: '0', width: '0', events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange }});
    }
    function onPlayerReady(event) {}
    function onPlayerStateChange(event) {
      if (event.data == YT.PlayerState.ENDED) {
        resetarItem(itemTocandoAtualmente);
        itemTocandoAtualmente = null;
        clearInterval(progressInterval);
      }
    }
    function extrairVideoID(url) {
      try { const urlObj = new URL(url); if (urlObj.hostname.includes("youtube.com")) return urlObj.searchParams.get("v"); if (urlObj.hostname.includes("youtu.be")) return urlObj.pathname.slice(1); } catch (e) { console.error("URL inválida:", e); } return null;
    }
    function formatarTempo(segundos) {
      const min = Math.floor(segundos / 60); const seg = Math.floor(segundos % 60).toString().padStart(2, '0'); return `${min}:${seg}`;
    }

    function renderizarAudios() {
      const listaContainer = document.getElementById('lista-de-audios');
      const audios = JSON.parse(sessionStorage.getItem('meusAudios')) || [];
      listaContainer.innerHTML = '';
      audios.forEach(audio => {
        const tagClass = audio.tag ? audio.tag.toLowerCase() : 'geral';
        const audioHTML = `
          <div class="item-lista audio" data-video-id="${audio.id}">
            <div class="item-icone"><img src="/images/play-audio.png" alt="Play"></div>
            <div class="item-info">
              <h4>${audio.titulo} <span class="tag-categoria ${tagClass}">${audio.tag}</span></h4>
              <p>${audio.descricao}</p>
              <div class="item-meta">
                <span class="meta-duracao"><img src="/images/tempo.png" alt="Duração"> --:--</span>
              </div>
            </div>
            <div class="item-acao"><img src="/images/volume.png" alt="Volume" class="icone-volume"></div>
            <div class="audio-progresso-container"><div class="audio-progresso-barra"></div></div>
            <div class="audio-tempo">
              <span class="tempo-atual">0:00</span> / <span class="tempo-total">--:--</span>
            </div>
          </div>
        `;
        listaContainer.innerHTML += audioHTML;
      });
      configurarInteracoes();
    }
    
    function configurarInteracoes() {
        const todosOsAudios = document.querySelectorAll('.item-lista.audio');
        todosOsAudios.forEach(item => {
            if (item.classList.contains('interativo')) return; 
            item.classList.add('interativo');
            const videoId = item.dataset.videoId;
            const iconeImg = item.querySelector('.item-icone img');
            item.addEventListener('click', function() {
                if(!player || typeof player.getPlayerState !== 'function') return;
                if (item === itemTocandoAtualmente) {
                    const playerState = player.getPlayerState();
                    if (playerState === YT.PlayerState.PLAYING) { player.pauseVideo(); iconeImg.src = '/images/play-audio.png'; }
                    else { player.playVideo(); iconeImg.src = '/images/pause.png'; }
                } else {
                    resetarItem(itemTocandoAtualmente);
                    itemTocandoAtualmente = item;
                    player.loadVideoById(videoId);
                    iconeImg.src = '/images/pause.png';
                    item.classList.add('tocando');
                    if (progressInterval) clearInterval(progressInterval);
                    progressInterval = setInterval(atualizarProgresso, 250);
                }
            });
            const iconeVolume = item.querySelector('.icone-volume');
            iconeVolume.addEventListener('click', function(e) {
                e.stopPropagation();
                if(player && typeof player.isMuted === 'function') {
                    if (player.isMuted()) { player.unMute(); iconeVolume.src = '/images/volume.png'; }
                    else { player.mute(); iconeVolume.src = '/images/volume-mute.png'; }
                }
            });
            const progressoContainer = item.querySelector('.audio-progresso-container');
            progressoContainer.addEventListener('click', function(e) {
                if (item !== itemTocandoAtualmente || !player || typeof player.getDuration !== 'function') return;
                const porcentagem = e.offsetX / progressoContainer.clientWidth;
                player.seekTo(player.getDuration() * porcentagem, true);
            });
        });
    }
    function atualizarProgresso() {
        if (!itemTocandoAtualmente || typeof player.getPlayerState !== 'function' || player.getPlayerState() !== YT.PlayerState.PLAYING) return;
        const duracao = player.getDuration();
        const tempoAtual = player.getCurrentTime();
        if (duracao > 0) {
            const progresso = (tempoAtual / duracao) * 100;
            itemTocandoAtualmente.querySelector('.audio-progresso-barra').style.width = `${progresso}%`;
            itemTocandoAtualmente.querySelector('.meta-duracao').innerHTML = `<img src="/images/tempo.png" alt="Duração"> ${formatarTempo(duracao)}`;
            itemTocandoAtualmente.querySelector('.tempo-atual').textContent = formatarTempo(tempoAtual);
            itemTocandoAtualmente.querySelector('.tempo-total').textContent = formatarTempo(duracao);
        }
    }
    function resetarItem(item) {
        if (!item) return;
        item.classList.remove('tocando');
        item.querySelector('.item-icone img').src = '/images/play-audio.png';
    }

    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('modal-adicionar-audio');
      const btnAbrir = document.getElementById('btn-abrir-modal');
      const btnFechar = document.getElementById('btn-fechar-modal');
      const form = document.getElementById('form-audio');
      
      const linkInput = document.getElementById('audio-link');
      const previewContainer = document.getElementById('audio-preview-container');
      const placeholder = '<p class="preview-placeholder">A pré-visualização do vídeo/áudio aparecerá aqui.</p>';

      if (!sessionStorage.getItem('meusAudios')) {
        const audiosIniciais = [
          { titulo: 'Dicas de segurança online', descricao: 'Como se proteger de golpes e fraudes na internet', id: '2OwABbFf_d8', tag: 'Segurança' },
          { titulo: 'Evitando golpes digitais', descricao: 'Principais golpes digitais e como evitá-los', id: 'c8NxH0HxUHM', tag: 'Segurança' },
          { titulo: 'O que é Privacidade de Dados?', descricao: 'Entenda a importância de proteger suas informações', id: 'j8-gHPfoHgs', tag: 'Privacidade'}
        ];
        sessionStorage.setItem('meusAudios', JSON.stringify(audiosIniciais));
      }

      btnAbrir.addEventListener('click', () => { modal.style.display = 'flex'; });
      btnFechar.addEventListener('click', () => {
          modal.style.display = 'none';
          previewContainer.innerHTML = placeholder; // Limpa o preview
          form.reset();
      });

      // LÓGICA DA PRÉ-VISUALIZAÇÃO EM TEMPO REAL
      linkInput.addEventListener('input', function() {
        const url = linkInput.value;
        const videoId = extrairVideoID(url);
        if (videoId) {
          previewContainer.innerHTML = `<div class="video-responsivo"><iframe src="https://www.youtube.com/embed/${videoId}" title="Pré-visualização" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe></div>`;
        } else {
          previewContainer.innerHTML = placeholder;
        }
      });

      form.addEventListener('submit', function(event) {
        event.preventDefault();
        const titulo = document.getElementById('audio-titulo').value;
        const descricao = document.getElementById('audio-desc').value;
        const link = document.getElementById('audio-link').value;
        const tag = document.getElementById('audio-tag').value;
        const videoID = extrairVideoID(link);
        
        if (!videoID) {
          alert('Por favor, insira um link válido do YouTube.');
          return;
        }

        const audiosAtuais = JSON.parse(sessionStorage.getItem('meusAudios')) || [];
        audiosAtuais.push({ titulo, descricao, id: videoID, tag });
        sessionStorage.setItem('meusAudios', JSON.stringify(audiosAtuais));

        btnFechar.click(); // Simula clique no fechar para limpar e esconder o modal
        renderizarAudios();
      });

      renderizarAudios();
    });
  </script>
  <script src="/js/app.js"></script>
  <script>
    // Checa se existe usuário logado no localStorage
    var usuarioJSON = localStorage.getItem("usuarioLogado");
    var usuarioLogado = JSON.parse(usuarioJSON)

    if (!usuarioLogado) {
      alert("Você precisa estar logado para acessar esta página.");
      window.location.href = "login.html";
    }
    const h2 = document.getElementById("bem-vindo");
    h2.textContent = `Bem-vindo(a), ${usuarioLogado.nome}!`;
  </script>
</body>
</html>