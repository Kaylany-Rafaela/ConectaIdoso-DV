<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Cadastrar Evento - Admin</title>
  <link rel="stylesheet" href="/css/estilo.css">
</head>
<body class="pagina-cadastrar">
  <div class="caixa">
    <div class="cabecalho">
      <button class="btn-voltar" onclick="window.location.href='painel-adm.html'">Voltar</button>
      <img src="/images/logo-pequena.jpeg" alt="Conecta Idoso" class="logo">
      <button class="btn-sair" onclick="sair()">Sair</button>
    </div>

    <h2>Cadastrar Evento para Usuário</h2>

    <form id="form-cadastrar-evento" class="form-grid">
      <div class="column-left">
        <div class="form-group">
          <label for="idoso-select">Usuário (idoso):</label>
          <select id="idoso-select" required></select>
        </div>

        <div class="form-group">
          <label for="evento-descricao">Descrição:</label>
          <input id="evento-descricao" type="text">
        </div>

        <div class="form-group">
          <label for="evento-hora">Hora:</label>
          <input id="evento-hora" type="time" required>
        </div>
      </div>

      <div class="column-right">
        <div class="form-group">
          <label for="evento-titulo">Título:</label>
          <input id="evento-titulo" type="text" required>
        </div>

        <div class="form-group">
          <label for="evento-data">Data:</label>
          <input id="evento-data" type="date" required>
        </div>

        <div class="form-group">
          <label for="evento-cor">Cor:</label>
          <select id="evento-cor" required>
            <option value="#27ae60">Verde</option>
            <option value="#e74c3c">Vermelho</option>
            <option value="#f1c40f">Amarelo</option>
            <option value="#000000">Preto</option>
            <option value="#8e44ad">Violeta</option>
            <option value="#3498db">Azul</option>
          </select>
        </div>
      </div>

      <div style="grid-column: 1 / -1; text-align: right;">
        <button type="button" class="btn-cancelar" onclick="window.history.back()">Cancelar</button>
        <button type="submit" class="btn-principal">Salvar Evento</button>
      </div>
    </form>

  </div>

  <script>
    async function carregarUsuariosNaoAdmin() {
      const sel = document.getElementById('idoso-select');
      sel.innerHTML = '<option>Carregando...</option>';
      try {
        const usuarioRaw = localStorage.getItem('usuarioLogado');
        const usuario = usuarioRaw ? JSON.parse(usuarioRaw) : null;

        // Se o usuário logado é admin e tem um contato (telefone do idoso vinculado), tentamos preencher automaticamente
        if (usuario && (usuario.isAdmin === true || usuario.isAdmin === 'true' || usuario.isAdmin === 1) && usuario.contato) {
          // busca usuario por telefone (contato armazena telefone do idoso quando associado)
          const resp = await fetch(`/usuarios/por-telefone/${encodeURIComponent(usuario.contato)}`);
          if (resp.ok) {
            const idoso = await resp.json();
            sel.innerHTML = '';
            const opt = document.createElement('option');
            opt.value = idoso.id;
            opt.textContent = idoso.nome;
            sel.appendChild(opt);
            sel.disabled = true; // não permitir alteração, pois vinculamos ao idoso do admin
            return;
          }
        }

        // fallback: listagem de todos os não-admins
        const resp2 = await fetch('/api/agenda/usuarios/nao-admin');
        if (!resp2.ok) throw new Error('falha');
        const usuarios = await resp2.json();
        sel.innerHTML = '';
        usuarios.forEach(u => {
          const opt = document.createElement('option');
          opt.value = u.id;
          opt.textContent = u.nome;
          sel.appendChild(opt);
        });
      } catch (e) {
        sel.innerHTML = '<option>Erro ao carregar usuários</option>';
        console.error('carregarUsuariosNaoAdmin', e);
      }
    }

    document.getElementById('form-cadastrar-evento').addEventListener('submit', async function(e) {
      e.preventDefault();
      const idosoId = document.getElementById('idoso-select').value;
      const titulo = document.getElementById('evento-titulo').value;
      const descricao = document.getElementById('evento-descricao').value;
      const data = document.getElementById('evento-data').value;
      const hora = document.getElementById('evento-hora').value;
      const cor = document.getElementById('evento-cor').value;

      if (!idosoId || !data || !hora) { alert('Preencha os campos obrigatórios'); return; }

      // construir ISO datetime
      const dataHora = `${data}T${hora}:00`;

      // obter id do criador (usuario logado)
      const usuarioRaw = localStorage.getItem('usuarioLogado');
      const usuario = usuarioRaw ? JSON.parse(usuarioRaw) : null;
      const criadorId = usuario ? usuario.id : null;

      const payload = { descricao, titulo, dataHora, cor, idosoId: String(idosoId), criadorId: criadorId ? String(criadorId) : null };

      const resp = await fetch('/api/agenda', {
        method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(payload)
      });
      if (resp.ok) {
        alert('Evento salvo com sucesso');
        window.location.href = 'agenda.html';
      } else {
        const txt = await resp.text();
        alert('Erro: ' + txt);
      }
    });

    carregarUsuariosNaoAdmin();
  </script>
</body>
</html>
